# Red Insight 技术架构文档

## 1. 系统概述

Red Insight 是一个基于 AI Agent 的小红书内容洞察平台，用户可以通过自然语言表达需求，Agent 自动理解意图、抓取小红书内容并生成可视化分析报告。

## 2. 系统架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Red Insight 系统架构                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        前端层 (Frontend)                              │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                   │   │
│  │  │  对话交互    │  │ 可视化报告   │  │ 执行日志面板 │                   │   │
│  │  │  Interface  │  │  Dashboard  │  │  Log Panel  │                   │   │
│  │  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘                   │   │
│  │         │                │                │                          │   │
│  │         └────────────────┼────────────────┘                          │   │
│  │                          │                                           │   │
│  │                    HTTP/WebSocket                                    │   │
│  └──────────────────────────┼───────────────────────────────────────────┘   │
│                             │                                               │
│  ┌──────────────────────────┼───────────────────────────────────────────┐   │
│  │                    API 网关层 (FastAPI)                               │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                   │   │
│  │  │ /api/chat   │  │ /api/search │  │ /api/health │                   │   │
│  │  │  对话接口    │  │  搜索接口    │  │  健康检查   │                   │   │
│  │  └──────┬──────┘  └──────┬──────┘  └─────────────┘                   │   │
│  │         │                │                                           │   │
│  │         └────────┬───────┘                                           │   │
│  └──────────────────┼───────────────────────────────────────────────────┘   │
│                     │                                                       │
│  ┌──────────────────┼───────────────────────────────────────────────────┐   │
│  │              AI Agent 核心层 (agent.py)                               │   │
│  │                     │                                                 │   │
│  │  ┌──────────────────┴──────────────────┐                             │   │
│  │  │         RedInsightAgent             │                             │   │
│  │  │  ┌─────────────────────────────┐    │                             │   │
│  │  │  │  1. 意图理解 (LLM)          │    │                             │   │
│  │  │  │  2. 关键词提取              │    │                             │   │
│  │  │  │  3. 任务编排                │    │                             │   │
│  │  │  │  4. 结果分析 (LLM)          │    │                             │   │
│  │  │  │  5. 步骤追踪                │    │                             │   │
│  │  │  └─────────────────────────────┘    │                             │   │
│  │  └─────────────────────────────────────┘                             │   │
│  │         │                    │                                        │   │
│  │         │                    │                                        │   │
│  │    ┌────┴────┐          ┌────┴────┐                                  │   │
│  │    │  LLM    │          │ Scraper │                                  │   │
│  │    │ Client  │          │  模块   │                                  │   │
│  │    └────┬────┘          └────┬────┘                                  │   │
│  └─────────┼────────────────────┼───────────────────────────────────────┘   │
│            │                    │                                           │
│  ┌─────────┼────────────────────┼───────────────────────────────────────┐   │
│  │    外部服务层                │                                        │   │
│  │         │                    │                                        │   │
│  │    ┌────┴────┐          ┌────┴────┐                                  │   │
│  │    │ 阿里云   │          │ 小红书   │                                  │   │
│  │    │ 百炼API  │          │ 网站    │                                  │   │
│  │    │(通义千问)│          │(Playwright)                                │   │
│  │    └─────────┘          └─────────┘                                  │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 3. 核心模块说明

### 3.1 前端层 (static/index.html)

| 组件 | 功能描述 |
|------|---------|
| 对话交互界面 | 用户输入自然语言需求，支持快捷提示 |
| 可视化报告 | 展示统计卡片、帖子列表、AI 分析结果 |
| 执行日志面板 | 实时显示 Agent 执行步骤和抓取数据 |

### 3.2 API 网关层 (main.py)

```python
# 核心接口
POST /api/chat      # 与 AI Agent 对话
POST /api/search    # 直接搜索（跳过 Agent）
GET  /api/health    # 健康检查
POST /api/clear-session  # 清除会话
```

### 3.3 AI Agent 核心层 (agent.py)

```
Agent 执行流程:
┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
│ 接收输入  │───▶│ 意图理解  │───▶│ 提取关键词│───▶│ 抓取内容  │───▶│ AI 分析  │
│          │    │  (LLM)   │    │          │    │(Scraper) │    │  (LLM)   │
└──────────┘    └──────────┘    └──────────┘    └──────────┘    └──────────┘
                                                                      │
┌──────────────────────────────────────────────────────────────────────┘
│
▼
┌──────────┐    ┌──────────┐
│ 生成报告  │───▶│ 返回结果  │
│          │    │ + 步骤   │
└──────────┘    └──────────┘
```

### 3.4 爬虫模块 (scraper.py)

- **技术栈**: Playwright (Chromium)
- **反爬策略**: Cookie 注入、User-Agent 伪装、webdriver 隐藏
- **数据提取**: DOM 选择器 + 页面 JSON 解析

## 4. 数据流图

```
用户输入
    │
    ▼
┌─────────────────┐
│   FastAPI 接口   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│   AI Agent      │
│  ┌───────────┐  │
│  │ 意图理解   │◀─────────┐
│  └─────┬─────┘          │
│        ▼                │
│  ┌───────────┐          │
│  │ 关键词提取 │          │
│  └─────┬─────┘          │
│        ▼                │  LLM API
│  ┌───────────┐          │ (阿里云百炼)
│  │ 小红书抓取 │──────────┤
│  └─────┬─────┘          │
│        ▼                │
│  ┌───────────┐          │
│  │ 内容分析   │◀─────────┘
│  └─────┬─────┘
│        ▼
│  ┌───────────┐
│  │ 步骤记录   │
│  └───────────┘
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│   JSON 响应     │
│  - message      │
│  - posts[]      │
│  - analysis     │
│  - steps[]      │
└─────────────────┘
         │
         ▼
┌─────────────────┐
│   前端渲染      │
│  - 可视化报告   │
│  - 执行日志     │
└─────────────────┘
```

## 5. 技术栈

| 层级 | 技术 | 版本 |
|------|------|------|
| 前端 | HTML5 + CSS3 + JavaScript | - |
| 后端框架 | FastAPI | ≥0.110.0 |
| AI 模型 | 阿里云百炼 (通义千问) | qwen-turbo |
| 爬虫引擎 | Playwright | ≥1.41.0 |
| Python | Python | ≥3.10 |

## 6. 部署架构

```
┌─────────────────────────────────────────────────────┐
│                   Docker Container                   │
│  ┌───────────────────────────────────────────────┐  │
│  │              Red Insight App                   │  │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────────┐   │  │
│  │  │ FastAPI │  │  Agent  │  │  Playwright │   │  │
│  │  │  :8080  │  │         │  │  (Chromium) │   │  │
│  │  └─────────┘  └─────────┘  └─────────────┘   │  │
│  └───────────────────────────────────────────────┘  │
│                         │                            │
│  ┌──────────────────────┼────────────────────────┐  │
│  │                 Volumes                        │  │
│  │  /app/logs  ◀────────┘                        │  │
│  │  /app/data                                     │  │
│  └────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────┘
            │
            │ Port 8080
            ▼
┌─────────────────────┐
│    Nginx (可选)      │
│    反向代理/SSL     │
└─────────────────────┘
            │
            ▼
        用户浏览器
```

## 7. 扩展性设计

### 7.1 支持多数据源
- 可扩展支持抖音、微博等平台
- 统一的 Scraper 接口设计

### 7.2 支持多 LLM
- 已支持 OpenAI 兼容接口
- 可切换智谱、阿里云、OpenAI 等

### 7.3 支持分布式部署
- 无状态设计，支持水平扩展
- 会话可迁移到 Redis

## 8. 安全考虑

1. **Cookie 安全**: Cookie 存储在服务端配置文件，不暴露给前端
2. **API 限流**: 可添加请求频率限制
3. **输入验证**: 对用户输入进行清理和验证
4. **CORS 配置**: 生产环境需限制允许的源

